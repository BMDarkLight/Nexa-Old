name: CD

on:
  push:
    branches: [main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - package-name: nexa
            dockerfile: ./Dockerfile
          - package-name: nexa-api
            dockerfile: ./Dockerfile.api
          - package-name: nexa-ui
            dockerfile: ./Dockerfile.ui

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ matrix.package-name }}
            ghcr.io/${{ github.repository }}/${{ matrix.package-name }}
          tags: |
            type=sha,prefix=,format=short
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image for ${{ matrix.package-name }}
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create .env file from secrets
        run: |
          cat > .env <<EOF
          SYSADMIN_USERNAME=${{ secrets.SYSADMIN_USERNAME }}
          SYSADMIN_PASSWORD=${{ secrets.SYSADMIN_PASSWORD }}
          SYSADMIN_FIRSTNAME=${{ secrets.SYSADMIN_FIRSTNAME }}
          SYSADMIN_LASTNAME=${{ secrets.SYSADMIN_LASTNAME }}
          SYSADMIN_EMAIL=${{ secrets.SYSADMIN_EMAIL }}
          SYSADMIN_PHONE=${{ secrets.SYSADMIN_PHONE }}

          SERVER_URL=${{ secrets.SERVER_URL }}
          NEXT_PUBLIC_SERVER_URL=${{ secrets.NEXT_PUBLIC_SERVER_URL }}
          UI_PORT=${{ secrets.UI_PORT }}
          API_PORT=${{ secrets.API_PORT }}

          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

          LANGSMITH_TRACING=${{ secrets.LANGSMITH_TRACING }}
          LANGSMITH_ENDPOINT=${{ secrets.LANGSMITH_ENDPOINT }}
          LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}
          LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}

          MONGO_URI=${{ secrets.MONGO_URI }}

          AUTH_SECRET_KEY=${{ secrets.AUTH_SECRET_KEY }}
          AUTH_ALGORITHM=${{ secrets.AUTH_ALGORITHM }}
          AUTH_TOKEN_EXPIRE=${{ secrets.AUTH_TOKEN_EXPIRE }}

          USE_SMTP=${{ secrets.USE_SMTP }}
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
          SMTP_SENDER=${{ secrets.SMTP_SENDER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}

          RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
          EOF

      - name: Verify .env and docker-compose.yml exist
        run: |
          set -e
          if [ ! -f ".env" ]; then
            echo "❌ .env file is missing!"
            exit 1
          fi
          if [ ! -f "docker-compose.yml" ]; then
            echo "❌ docker-compose.yml is missing!"
            exit 1
          fi
          echo "✅ Required files exist:"
          ls -la .env docker-compose.yml

      - name: Copy docker-compose and .env to VPS
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: |
            docker-compose.yml
            .env
          target: /home/nexa/

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            if [ ! -f "/home/nexa/.env" ]; then
              echo "❌ Remote .env file is missing!"
              exit 1
            fi
            if [ ! -f "/home/nexa/docker-compose.yml" ]; then
              echo "❌ Remote docker-compose.yml is missing!"
              exit 1
            fi
            echo "✅ Remote files verified"

            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}
            cd /home/nexa
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nexa-api:latest
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/nexa-ui:latest
            docker compose --env-file /home/nexa/.env up -d --no-build
